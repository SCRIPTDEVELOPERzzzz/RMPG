local Library = loadstring(game:HttpGet("https://raw.githubusercontent.com/SenScriptsReworkVoidVersion/Lib/refs/heads/main/Hh"))()

local Window = Library:CreateWindow{
    Title = "K13 Paid Fluent |",
    SubTitle = "Version 1.0.0",
    Size = UDim2.fromOffset(500, 350),
    TabWidth = 120,
    Acrylic = true,
    Theme = "Purple"
}

----------------------------------------------------------
-- HOME TAB
----------------------------------------------------------
local HomeTab = Window:AddTab{ 
    Title = "Home", 
    Icon = "home"
}

local HomeSection = HomeTab:AddSection("Main")

-- Speed Placeholder
HomeSection:AddInput("SpeedInput", {
    Title = "Speed",
    Default = "",
    Callback = function(val)
        _G.speedValue = tonumber(val) or 16
    end
})

-- Apply Speed Toggle
HomeSection:AddToggle("SpeedToggle", {
    Title = "Apply Speed",
    Default = false,
    Callback = function(state)
        local char = game.Players.LocalPlayer.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum.WalkSpeed = state and (_G.speedValue or 16) or 16
        end
    end
})

-- Jump Power Placeholder
HomeSection:AddInput("JumpInput", {
    Title = "Jump Power",
    Default = "",
    Callback = function(val)
        _G.jumpValue = tonumber(val) or 50
    end
})

-- Apply Jump Power Toggle
HomeSection:AddToggle("JumpToggle", {
    Title = "Apply JumpPower",
    Default = false,
    Callback = function(state)
        local char = game.Players.LocalPlayer.Character
        local hum = char and char:FindFirstChildOfClass("Humanoid")
        if hum then
            hum.JumpPower = state and (_G.jumpValue or 50) or 50
        end
    end
})

local selectedSize = 2

HomeSection:AddInput("SizeInput", {
	Title = "Size",
	Default = "2",
	Placeholder = "Enter Size...",
	Callback = function(val)
		selectedSize = tonumber(val) or 2
		if getgenv().AutoSize then
			game:GetService("ReplicatedStorage").rEvents.changeSpeedSizeRemote:InvokeServer("changeSize", selectedSize)
		end
	end,
})

HomeSection:AddToggle("AutoSize", {
	Title = "Apply Size",
	Default = false,
	Callback = function(state)
		getgenv().AutoSize = state
		while getgenv().AutoSize do
			game:GetService("ReplicatedStorage").rEvents.changeSpeedSizeRemote:InvokeServer("changeSize", selectedSize)
			task.wait(0.1)
		end
	end,
})

----------------------------------------------------------
-- TOOLS TAB
----------------------------------------------------------
local ToolsTab = Window:AddTab{
    Title = "Tools",
    Icon = "wrench"
}

local ToolsSection = ToolsTab:AddSection("Auto Tools")

-- Auto Weight
ToolsSection:AddToggle("AutoWeight", {
    Title = "Auto Weight",
    Default = false,
    Callback = function(Value)
        _G.AutoWeight = Value
        if Value then
            local weightTool = game.Players.LocalPlayer.Backpack:FindFirstChild("Weight")
            if weightTool then
                game.Players.LocalPlayer.Character.Humanoid:EquipTool(weightTool)
            end
        else
            local char = game.Players.LocalPlayer.Character
            local tool = char:FindFirstChild("Weight")
            if tool then tool.Parent = game.Players.LocalPlayer.Backpack end
        end

        task.spawn(function()
            while _G.AutoWeight do
                game:GetService("Players").LocalPlayer.muscleEvent:FireServer("rep")
                task.wait(0.1)
            end
        end)
    end
})

-- Auto Pushups
ToolsSection:AddToggle("AutoPushups", {
    Title = "Auto Pushups",
    Default = false,
    Callback = function(Value)
        _G.AutoPushups = Value
        if Value then
            local tool = game.Players.LocalPlayer.Backpack:FindFirstChild("Pushups")
            if tool then
                game.Players.LocalPlayer.Character.Humanoid:EquipTool(tool)
            end
        else
            local char = game.Players.LocalPlayer.Character
            local tool = char:FindFirstChild("Pushups")
            if tool then tool.Parent = game.Players.LocalPlayer.Backpack end
        end

        task.spawn(function()
            while _G.AutoPushups do
                game:GetService("Players").LocalPlayer.muscleEvent:FireServer("rep")
                task.wait(0.1)
            end
        end)
    end
})

-- Auto Handstands
ToolsSection:AddToggle("AutoHandstands", {
    Title = "Auto Handstands",
    Default = false,
    Callback = function(Value)
        _G.AutoHandstands = Value
        if Value then
            local tool = game.Players.LocalPlayer.Backpack:FindFirstChild("Handstands")
            if tool then
                game.Players.LocalPlayer.Character.Humanoid:EquipTool(tool)
            end
        else
            local char = game.Players.LocalPlayer.Character
            local tool = char:FindFirstChild("Handstands")
            if tool then tool.Parent = game.Players.LocalPlayer.Backpack end
        end

        task.spawn(function()
            while _G.AutoHandstands do
                game:GetService("Players").LocalPlayer.muscleEvent:FireServer("rep")
                task.wait(0.1)
            end
        end)
    end
})

-- Auto Situps
ToolsSection:AddToggle("AutoSitups", {
    Title = "Auto Situps",
    Default = false,
    Callback = function(Value)
        _G.AutoSitups = Value
        if Value then
            local tool = game.Players.LocalPlayer.Backpack:FindFirstChild("Situps")
            if tool then
                game.Players.LocalPlayer.Character.Humanoid:EquipTool(tool)
            end
        else
            local char = game.Players.LocalPlayer.Character
            local tool = char:FindFirstChild("Situps")
            if tool then tool.Parent = game.Players.LocalPlayer.Backpack end
        end

        task.spawn(function()
            while _G.AutoSitups do
                game:GetService("Players").LocalPlayer.muscleEvent:FireServer("rep")
                task.wait(0.1)
            end
        end)
    end
})

-- Auto Punch
ToolsSection:AddToggle("AutoPunch", {
    Title = "Auto Punch",
    Default = false,
    Callback = function(Value)
        _G.fastHitActive = Value
        if Value then
            task.spawn(function()
                while _G.fastHitActive do
                    local player = game.Players.LocalPlayer
                    local punch = player.Backpack:FindFirstChild("Punch")
                    if punch then
                        punch.Parent = player.Character
                        if punch:FindFirstChild("attackTime") then
                            punch.attackTime.Value = 0
                        end
                    end
                    task.wait(0.1)
                end
            end)
            task.spawn(function()
                while _G.fastHitActive do
                    local player = game.Players.LocalPlayer
                    player.muscleEvent:FireServer("punch","rightHand")
                    player.muscleEvent:FireServer("punch","leftHand")
                    local punchTool = player.Character and player.Character:FindFirstChild("Punch")
                    if punchTool then punchTool:Activate() end
                    task.wait(0)
                end
            end)
        else
            local char = game.Players.LocalPlayer.Character
            local tool = char:FindFirstChild("Punch")
            if tool then tool.Parent = game.Players.LocalPlayer.Backpack end
        end
    end
})

-- Fast Tools
ToolsSection:AddToggle("FastTools", {
    Title = "Fast Tools",
    Default = false,
    Callback = function(Value)
        local defaultSpeeds = {
            {"Punch","attackTime",Value and 0 or 0.35},
            {"Ground Slam","attackTime",Value and 0 or 6},
            {"Stomp","attackTime",Value and 0 or 7},
            {"Handstands","repTime",Value and 0 or 1},
            {"Pushups","repTime",Value and 0 or 1},
            {"Weight","repTime",Value and 0 or 1},
            {"Situps","repTime",Value and 0 or 1}
        }
        local player = game.Players.LocalPlayer
        for _, toolInfo in ipairs(defaultSpeeds) do
            local tool = player.Backpack:FindFirstChild(toolInfo[1])
            if tool and tool:FindFirstChild(toolInfo[2]) then
                tool[toolInfo[2]].Value = toolInfo[3]
            end
            local equipTool = player.Character and player.Character:FindFirstChild(toolInfo[1])
            if equipTool and equipTool:FindFirstChild(toolInfo[2]) then
                equipTool[toolInfo[2]].Value = toolInfo[3]
            end
        end
    end
})

-- Jungle Gym Folder inside Tools tab
local jungleGymFolder = ToolsTab:AddSection("Jungle Gym")

-- Helper functions
local VIM = game:GetService("VirtualInputManager")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

local function pressE()
    VIM:SendKeyEvent(true, "E", false, game)
    task.wait(0.1)
    VIM:SendKeyEvent(false, "E", false, game)
end

local function autoLift()
    while getgenv().working do
        LocalPlayer.muscleEvent:FireServer("rep")
        task.wait()
    end
end

local function teleportAndStart(machineName, position)
    local character = LocalPlayer.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        character.HumanoidRootPart.CFrame = position
        task.wait(0.1)
        pressE()
        task.spawn(autoLift)
    end
end

-- Jungle Gym Bench Press
jungleGymFolder:AddToggle("JungleBenchPress", {
    Title = "Jungle Bench Press",
    Default = false,
    Callback = function(bool)
        if getgenv().working and not bool then
            getgenv().working = false
            return
        end
        
        getgenv().working = bool
        if bool then
            teleportAndStart("Bench Press", CFrame.new(-8173, 64, 1898))
        end
    end
})

-- Jungle Gym Squat
jungleGymFolder:AddToggle("JungleSquat", {
    Title = "Jungle Squat",
    Default = false,
    Callback = function(bool)
        if getgenv().working and not bool then
            getgenv().working = false
            return
        end
        
        getgenv().working = bool
        if bool then
            teleportAndStart("Squat", CFrame.new(-8352, 34, 2878))
        end
    end
})

-- Jungle Gym Pull Up
jungleGymFolder:AddToggle("JunglePullUps", {
    Title = "Jungle Pull Ups",
    Default = false,
    Callback = function(bool)
        if getgenv().working and not bool then
            getgenv().working = false
            return
        end
        
        getgenv().working = bool
        if bool then
            teleportAndStart("Pull Up", CFrame.new(-8666, 34, 2070))
        end
    end
})

-- Jungle Gym Boulder
jungleGymFolder:AddToggle("JungleBoulder", {
    Title = "Jungle Boulder",
    Default = false,
    Callback = function(bool)
        if getgenv().working and not bool then
            getgenv().working = false
            return
        end
        
        getgenv().working = bool
        if bool then
            teleportAndStart("Boulder", CFrame.new(-8621, 34, 2684))
        end
    end
})


-- Gym Folder inside Tools tab
local farmGymsFolder = ToolsTab:AddSection("Gym Automation")

local workoutPositions = {
    ["Bench Press"] = {
        ["Eternal Gym"] = CFrame.new(-7176.19141, 45.394104, -1106.31421),
        ["Legend Gym"] = CFrame.new(4111.91748, 1020.46674, -3799.97217),
        ["Muscle King Gym"] = CFrame.new(-8590.06152, 46.0167427, -6043.34717)
    },
    ["Squat"] = {
        ["Eternal Gym"] = CFrame.new(-7176.19141, 45.394104, -1106.31421),
        ["Legend Gym"] = CFrame.new(4304.99023, 987.829956, -4124.2334),
        ["Muscle King Gym"] = CFrame.new(-8940.12402, 13.1642084, -5699.13477)
    },
    ["Deadlift"] = {
        ["Eternal Gym"] = CFrame.new(-7176.19141, 45.394104, -1106.31421),
        ["Legend Gym"] = CFrame.new(4304.99023, 987.829956, -4124.2334),
        ["Muscle King Gym"] = CFrame.new(-8940.12402, 13.1642084, -5699.13477)
    },
    ["Pull Up"] = {
        ["Eternal Gym"] = CFrame.new(-7176.19141, 45.394104, -1106.31421),
        ["Legend Gym"] = CFrame.new(4304.99023, 987.829956, -4124.2334),
        ["Muscle King Gym"] = CFrame.new(-8940.12402, 13.1642084, -5699.13477)
    }
}

local workoutTypes = {"Bench Press", "Squat", "Deadlift", "Pull Up"}
local gymLocations = {"Eternal Gym", "Legend Gym", "Muscle King Gym"}

-- Initialize selected gyms
for _, workoutType in ipairs(workoutTypes) do
    _G["selected" .. workoutType:gsub(" ", "") .. "Gym"] = gymLocations[1]
    _G[workoutType:gsub(" ", "") .. "Active"] = false
end

local function disableOtherWorkouts(current)
    for _, workoutType in ipairs(workoutTypes) do
        if workoutType ~= current then
            _G[workoutType:gsub(" ", "") .. "Active"] = false
        end
    end
end

local function startWorkout(workoutType)
    local selectedGym = _G["selected" .. workoutType:gsub(" ", "") .. "Gym"]
    local position = workoutPositions[workoutType][selectedGym]

    if not position then
        pcall(function()
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "Error",
                Text = "Position not found for " .. workoutType .. " in " .. selectedGym,
                Duration = 5
            })
        end)
        return
    end

    if teleportAndStart then
        task.spawn(function()
            teleportAndStart(workoutType, position)
        end)
    else
        warn("teleportAndStart function missing!")
    end
end

for _, workoutType in ipairs(workoutTypes) do
    local workoutName = workoutType

    -- Dropdown
    farmGymsFolder:AddDropdown(workoutName .. "GymDropdown", {
        Title = workoutName .. " - Gym",
        Description = "Select Gym",
        Values = gymLocations,
        Default = gymLocations[1],
        Callback = function(selected)
            _G["selected" .. workoutType:gsub(" ", "") .. "Gym"] = selected
        end
    })

    -- Toggle
    farmGymsFolder:AddToggle(workoutName .. "GymToggle", {
        Title = workoutName,
        Default = false,
        Callback = function(bool)
            _G[workoutType:gsub(" ", "") .. "Active"] = bool

            if bool then
                disableOtherWorkouts(workoutType)
                startWorkout(workoutType)
            end
        end
    })
end

----------------------------------------------------------
-- OP FARM TAB
----------------------------------------------------------
local OpFarmTab = Window:AddTab{
    Title = "Op Farm",
    Icon = "star"
}

local OpFarmSection = OpFarmTab:AddSection("Rebirth & Farm Automation")

-- Rebirth Target Input
OpFarmSection:AddInput("RebirthTargetInput", {
    Title = "Rebirth Target",
    Default = "",
    Callback = function(text)
        local newValue = tonumber(text)
        if newValue and newValue > 0 then
            targetRebirthValue = newValue
            updateStats() -- Make sure this function exists
            
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "Updated Objective",
                Text = "New goal: " .. tostring(targetRebirthValue) .. " rebirth",
                Duration = 0
            })
        else
            game:GetService("StarterGui"):SetCore("SendNotification", {
                Title = "Invalid Entry",
                Text = "Please enter a valid number",
                Duration = 0
            })
        end
    end
})

-- Auto Rebirth Target Toggle
local targetRebirthToggle
targetRebirthToggle = OpFarmSection:AddToggle("AutoRebirthTarget", {
    Title = "Auto Rebirth Target",
    Default = false,
    Callback = function(state)
        _G.targetRebirthActive = state
        
        if state then
            -- Turn off infinite rebirth if it's active
            if _G.infiniteRebirthActive and infiniteSwitch then
                infiniteSwitch:Set(false)
                _G.infiniteRebirthActive = false
            end
            
            task.spawn(function()
                while _G.targetRebirthActive do
                    local currentRebirths = game.Players.LocalPlayer.leaderstats.Rebirths.Value
                    if currentRebirths >= targetRebirthValue then
                        targetRebirthToggle:Set(false)
                        _G.targetRebirthActive = false
                        
                        game:GetService("StarterGui"):SetCore("SendNotification", {
                            Title = "Goal Achieved!!",
                            Text = "You have reached " .. tostring(targetRebirthValue) .. " rebirth",
                            Duration = 5
                        })
                        break
                    end
                    
                    game:GetService("ReplicatedStorage").rEvents.rebirthRemote:InvokeServer("rebirthRequest")
                    task.wait(0.1)
                end
            end)
        end
    end
})

-- Auto Weight Toggle
OpFarmSection:AddToggle("AutoWeight", {
    Title = "Auto Weight",
    Default = false,
    Callback = function(state)
        _G.FastWeight = state
        
        if state then
            -- Continuously equip and modify weight tool
            task.spawn(function()
                while _G.FastWeight do
                    local player = game.Players.LocalPlayer
                    local character = player.Character
                    
                    if character and not character:FindFirstChild("Weight") then
                        local weightTool = player.Backpack:FindFirstChild("Weight")
                        if weightTool and weightTool:FindFirstChild("repTime") then
                            weightTool.repTime.Value = 0
                            character.Humanoid:EquipTool(weightTool)
                        end
                    elseif character and character:FindFirstChild("Weight") then
                        local equipped = character:FindFirstChild("Weight")
                        if equipped:FindFirstChild("repTime") then
                            equipped.repTime.Value = 0
                        end
                    end
                    
                    task.wait(0.1)
                end
            end)
            
            -- Auto do weight lifting
            task.spawn(function()
                while _G.FastWeight do
                    game.Players.LocalPlayer.muscleEvent:FireServer("rep")
                    task.wait(0)
                end
            end)
        else
            -- Unequip and reset tool
            local character = game.Players.LocalPlayer.Character
            local equipped = character:FindFirstChild("Weight")
            if equipped then
                if equipped:FindFirstChild("repTime") then
                    equipped.repTime.Value = 1
                end
                equipped.Parent = game.Players.LocalPlayer.Backpack
            end
            
            local backpackTool = game.Players.LocalPlayer.Backpack:FindFirstChild("Weight")
            if backpackTool and backpackTool:FindFirstChild("repTime") then
                backpackTool.repTime.Value = 1
            end
        end
    end
})

-- Auto Size Toggle
OpFarmSection:AddToggle("AutoSize1", {
    Title = "Auto Size 1",
    Default = false,
    Callback = function(state)
        _G.autoSizeActive = state
        
        if state then
            task.spawn(function()
                while _G.autoSizeActive do
                    game:GetService("ReplicatedStorage").rEvents.changeSpeedSizeRemote:InvokeServer("changeSize", 0)
                    task.wait()
                end
            end)
        end
    end
})

-- Auto Teleport Toggle
OpFarmSection:AddToggle("AutoTeleportMuscleKing", {
    Title = "Auto Teleport to Muscle King",
    Default = false,
    Callback = function(state)
        _G.teleportActive = state
        
        if state then
            task.spawn(function()
                while _G.teleportActive do
                    local char = game.Players.LocalPlayer.Character
                    if char then
                        char:MoveTo(Vector3.new(-8646, 17, -5738))
                    end
                    task.wait()
                end
            end)
        end
    end
})

-- Fast Rebirth Toggle
OpFarmSection:AddToggle("FastRebirth", {
    Title = "Fast Rebirth",
    Default = false,
    Callback = function(state)
        _G.isFastRebirthActive = state
        
        task.spawn(function()
            local player = game.Players.LocalPlayer
            while _G.isFastRebirthActive do
                -- Calculate rebirth cost
                local currentRebirths = player.leaderstats.Rebirths.Value
                local rebirthCost = 10000 + (5000 * currentRebirths)
                
                if player.ultimatesFolder:FindFirstChild("Golden Rebirth") then
                    local goldenRebirths = player.ultimatesFolder["Golden Rebirth"].Value
                    rebirthCost = math.floor(rebirthCost * (1 - (goldenRebirths * 0.1)))
                end

                -- Equip Swift Samurai
                unequipAllPets()
                task.wait(0.1)
                equipUniquePet("Swift Samurai")
                
                -- Farm until enough strength
                while _G.isFastRebirthActive and player.leaderstats.Strength.Value < rebirthCost do
                    for i = 1, 10 do
                        player.muscleEvent:FireServer("rep")
                    end
                    task.wait()
                end

                -- Equip Tribal Overlord for rebirth
                unequipAllPets()
                task.wait(0.1)
                equipUniquePet("Tribal Overlord")
                
                -- Go to Jungle Bar Lift machine
                local machine = findMachine("Jungle Bar Lift")
                if machine and machine:FindFirstChild("interactSeat") then
                    player.Character.HumanoidRootPart.CFrame = machine.interactSeat.CFrame * CFrame.new(0, 3, 0)
                    repeat
                        task.wait(0.1)
                        pressE()
                    until player.Character.Humanoid.Sit
                end

                -- Perform rebirth
                local initialRebirths = player.leaderstats.Rebirths.Value
                repeat
                    game:GetService("ReplicatedStorage").rEvents.rebirthRemote:InvokeServer("rebirthRequest")
                    task.wait(0.1)
                until player.leaderstats.Rebirths.Value > initialRebirths

                if not _G.isFastRebirthActive then break end
                task.wait()
            end
        end)
    end
})


OpFarmSection:AddToggle("FastStrength", {
    Title = "Fast Strength",
    Default = false,
    Callback = function(state)
        _G.isFastStrengthActive = state
        local player = game.Players.LocalPlayer
        if not player then return end

        if not state then
            -- Stop farming and unequip pets
            _G.isFastStrengthActive = false
            -- Ensure function unequipAllPets exists
            if unequipAllPets then
                unequipAllPets()
            end
            return
        end

        -- Equip the Swift Samurai pet
        if equipUniquePet then
            equipUniquePet("Swift Samurai")
        end

        -- Start strength farming
        task.spawn(function()
            while _G.isFastStrengthActive do
                if player and player:FindFirstChild("muscleEvent") then
                    pcall(function()
                        player.muscleEvent:FireServer("rep")
                    end)
                end
                task.wait(0.05)
            end
        end)
    end
})

-- Hide Frames Toggle
OpFarmSection:AddToggle("HideFrames", {
    Title = "Hide Frames",
    Default = false,
    Callback = function(state)
        local rSto = game:GetService("ReplicatedStorage")
        for _, obj in pairs(rSto:GetChildren()) do
            if obj.Name:match("Frame$") then
                obj.Visible = not state
            end
        end
    end
})

-- Hide Pets Toggle
OpFarmSection:AddToggle("HidePets", {
    Title = "Hide Pets",
    Default = false,
    Callback = function(state)
        if state then
            game:GetService("ReplicatedStorage").rEvents.showPetsEvent:FireServer("hidePets")
        else
            game:GetService("ReplicatedStorage").rEvents.showPetsEvent:FireServer("showPets")
        end
    end
})

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")

local GiftTab = Window:AddTab{ Title = "Gift", Icon = "gift" }
local GiftSection = GiftTab:AddSection("Gifting")

-- Prepare player lists
local function getPlayerNames()
    local names = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            table.insert(names, plr.DisplayName)
        end
    end
    return names
end

-- Selected players and amounts
local selectedEggPlayer = nil
local eggCount = 0
local selectedShakePlayer = nil
local shakeCount = 0

-- Protein Eggs
GiftSection:AddDropdown("EggPlayerDropdown", {
    Title = "Player to Gift Eggs",
    Values = getPlayerNames(),
    Default = "",
    Callback = function(selectedDisplayName)
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr.DisplayName == selectedDisplayName then
                selectedEggPlayer = plr
                break
            end
        end
    end
})

GiftSection:AddInput("EggAmountInput", {
    Title = "Amount of Eggs",
    Default = "",
    Callback = function(text)
        eggCount = tonumber(text) or 0
    end
})

GiftSection:AddButton({
    Title = "Gift Eggs",
    Callback = function()
        if selectedEggPlayer and eggCount > 0 then
            for i = 1, eggCount do
                local egg = LocalPlayer.consumablesFolder:FindFirstChild("Protein Egg")
                if egg then
                    ReplicatedStorage.rEvents.giftRemote:InvokeServer("giftRequest", selectedEggPlayer, egg)
                    task.wait(0.1)
                end
            end
        end
    end
})

-- Tropical Shakes
GiftSection:AddDropdown("ShakePlayerDropdown", {
    Title = "Player to Gift Tropical Shakes",
    Values = getPlayerNames(),
    Default = "",
    Callback = function(selectedDisplayName)
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr.DisplayName == selectedDisplayName then
                selectedShakePlayer = plr
                break
            end
        end
    end
})

GiftSection:AddInput("ShakeAmountInput", {
    Title = "Tropical Shakes gift",
    Default = "",
    Callback = function(text)
        shakeCount = tonumber(text) or 0
    end
})

GiftSection:AddButton({
    Title = "Gift Tropical Shakes",
    Callback = function()
        if selectedShakePlayer and shakeCount > 0 then
            for i = 1, shakeCount do
                local shake = LocalPlayer.consumablesFolder:FindFirstChild("Tropical Shake")
                if shake then
                    ReplicatedStorage.rEvents.giftRemote:InvokeServer("giftRequest", selectedShakePlayer, shake)
                    task.wait(0.1)
                end
            end
        end
    end
})

-- Update dropdowns when players join
Players.PlayerAdded:Connect(function(plr)
    if plr ~= LocalPlayer then
        local eggDropdown = GiftSection:GetElement("EggPlayerDropdown")
        local shakeDropdown = GiftSection:GetElement("ShakePlayerDropdown")
        if eggDropdown then eggDropdown:Add(plr.DisplayName) end
        if shakeDropdown then shakeDropdown:Add(plr.DisplayName) end
    end
end)


-- Services & locals
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local StarterPack = game:GetService("StarterPack")
local lighting = game:GetService("Lighting")
local LocalPlayer = Players.LocalPlayer

-- State trackers
local comboActive = false
local connections = {}
local loops = {}
local playerWhitelist = {}
local targetPlayerNames = {}
local targetDropdownItems = {}
local targetPlayerName = nil -- name (not DisplayName) of the player camera will follow

-- Helpers
local function safeDisconnect(key)
    local conn = connections[key]
    if not conn then return end
    pcall(function()
        if typeof(conn) == "RBXScriptConnection" and conn.Disconnect then
            conn:Disconnect()
        elseif type(conn) == "table" and conn.Disconnect then
            conn:Disconnect()
        end
    end)
    connections[key] = nil
end

local function stopLoops()
    for k, _ in pairs(loops) do
        loops[k] = nil
    end
end

local function cleanupAll()
    _G.AutoPunchToggle = false
    _G.AutoProteinEgg = false
    getgenv().AntiFlyActive = false

    for k, _ in pairs(connections) do
        safeDisconnect(k)
    end
    connections = {}
    stopLoops()
end

local function respawnPlayer()
    pcall(function()
        if LocalPlayer and LocalPlayer:IsA("Player") then
            if pcall(function() LocalPlayer:LoadCharacter() end) then return end
            pcall(function()
                local StarterGui = game:GetService("StarterGui")
                StarterGui:SetCore("ResetButtonCallback", true)
            end)
        end
    end)
end

local function applySizeNaN()
    pcall(function()
        local events = ReplicatedStorage:FindFirstChild("rEvents")
        if events then
            local change = events:FindFirstChild("changeSpeedSizeRemote")
            if change and change.InvokeServer then
                pcall(function()
                    change:InvokeServer("changeSize", 0/0)
                end)
            end
        end
    end)
end

-- Core features
local function startAutoPunch()
    _G.AutoPunchToggle = true
    local id = "AutoPunch"
    loops[id] = true
    task.spawn(function()
        local hand = "rightHand"
        local function getMuscleEvent() return LocalPlayer:FindFirstChild("muscleEvent") end

        safeDisconnect("CharAddedForAutoPunch")
        connections.CharAddedForAutoPunch = LocalPlayer.CharacterAdded:Connect(function(char)
            if comboActive and connections.HumanoidResetHook == nil then
                local hum = char:FindFirstChildOfClass("Humanoid")
                if hum then
                    safeDisconnect("ResetDeath")
                    connections.ResetDeath = hum.Died:Connect(function()
                        task.wait(0.5)
                        respawnPlayer()
                    end)
                end
            end
        end)

        safeDisconnect("BackpackChildForAutoPunch")
        connections.BackpackChildForAutoPunch = LocalPlayer.ChildAdded:Connect(function(child)
            if child.Name == "Backpack" then end
        end)

        while _G.AutoPunchToggle and loops[id] do
            local muscleEvent = getMuscleEvent()
            local character = LocalPlayer.Character
            if character and character:FindFirstChild("Humanoid") and muscleEvent then
                local punchEquipped = character:FindFirstChild("Punch")
                local punchInBackpack = (LocalPlayer:FindFirstChild("Backpack") and LocalPlayer.Backpack:FindFirstChild("Punch"))
                if not punchEquipped and punchInBackpack then
                    pcall(function() character.Humanoid:EquipTool(punchInBackpack) end)
                end
                pcall(function() muscleEvent:FireServer("punch", hand) end)
            end
            task.wait(0.0001)
        end
    end)
end

local function startProteinEggLogic()
    _G.AutoProteinEgg = true
    local id = "ProteinEgg"
    loops[id] = true
    task.spawn(function()
        local toolName = "Protein Egg"
        local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

        local function restoreVisibility(tool)
            for _, part in ipairs(tool:GetDescendants()) do
                if part:IsA("BasePart") then
                    pcall(function() part.Transparency = 0 end)
                    pcall(function() part.LocalTransparencyModifier = 0 end)
                end
            end
        end

        local function findTool()
            local tool = (LocalPlayer:FindFirstChild("Backpack") and LocalPlayer.Backpack:FindFirstChild(toolName))
            if tool then return tool end
            tool = StarterPack:FindFirstChild(toolName)
            if tool then return tool end
            tool = ReplicatedStorage:FindFirstChild(toolName)
            return tool
        end

        local function forceEquip(tool)
            if not (character and character:FindFirstChild("Humanoid")) then return end
            pcall(function() character.Humanoid:EquipTool(tool) end)
            task.wait(0.1)
            if not character:FindFirstChild(toolName) then
                pcall(function() tool.Parent = character end)
                task.wait(0.1)
            end
            local equipped = character:FindFirstChild(toolName)
            if equipped then restoreVisibility(equipped) end
        end

        local function sanitizeTool(tool)
            for _, desc in ipairs(tool:GetDescendants()) do
                if desc:IsA("Script") then
                    pcall(function() desc:Destroy() end)
                elseif desc:IsA("LocalScript") then
                    pcall(function() desc.Disabled = true end)
                end
                if desc:IsA("RemoteEvent") then
                    pcall(function() desc.FireServer = function() end end)
                end
            end
        end

        local function equipIfNeeded()
            if not _G.AutoProteinEgg then return end
            character = LocalPlayer.Character
            local equipped = character and character:FindFirstChild(toolName)
            local needEquip = false
            if not equipped then
                needEquip = true
            else
                for _, part in ipairs(equipped:GetDescendants()) do
                    if part:IsA("BasePart") and part.Transparency > 0 then
                        needEquip = true
                        break
                    end
                end
            end
            if needEquip then
                local tool = findTool()
                if tool then
                    if tool.Parent ~= (LocalPlayer:FindFirstChild("Backpack") and LocalPlayer.Backpack) then
                        local clone = tool:Clone()
                        clone.Parent = LocalPlayer:FindFirstChild("Backpack") or LocalPlayer
                        tool = clone
                    end
                    sanitizeTool(tool)
                    forceEquip(tool)
                end
            end
        end

        local function monitorToolContainer(container)
            if not container then return end
            for _, tool in ipairs(container:GetChildren()) do
                if tool:IsA("Tool") and tool.Name == toolName then
                    sanitizeTool(tool)
                end
            end
            local conn = container.ChildAdded:Connect(function(child)
                if child:IsA("Tool") and child.Name == toolName then
                    task.defer(function()
                        sanitizeTool(child)
                    end)
                end
            end)
            return conn
        end

        safeDisconnect("MonitorBackpack")
        safeDisconnect("MonitorCharacter")
        connections.MonitorBackpack = monitorToolContainer(LocalPlayer:FindFirstChild("Backpack") or LocalPlayer:WaitForChild("Backpack"))
        connections.MonitorCharacter = monitorToolContainer(LocalPlayer.Character)

        safeDisconnect("CharacterAddedProtein")
        connections.CharacterAddedProtein = LocalPlayer.CharacterAdded:Connect(function(char)
            character = char
            task.wait(1)
            safeDisconnect("MonitorBackpack")
            safeDisconnect("MonitorCharacter")
            connections.MonitorBackpack = monitorToolContainer(LocalPlayer:FindFirstChild("Backpack") or LocalPlayer:WaitForChild("Backpack"))
            connections.MonitorCharacter = monitorToolContainer(char)
            equipIfNeeded()
        end)

        safeDisconnect("BackpackChildProtein")
        connections.BackpackChildProtein = LocalPlayer:WaitForChild("Backpack").ChildAdded:Connect(function(child)
            if _G.AutoProteinEgg and child.Name == toolName then
                task.wait(0.2)
                equipIfNeeded()
            end
        end)

        while _G.AutoProteinEgg and loops[id] do
            pcall(equipIfNeeded)
            task.wait(0.5)
        end
    end)
end

local function startAntiFly()
    getgenv().AntiFlyActive = true
    safeDisconnect("AntiFly")
    connections.AntiFly = RunService.Heartbeat:Connect(function()
        local char = LocalPlayer.Character
        if not char then return end
        local root = char:FindFirstChild("HumanoidRootPart")
        if not root then return end
        local humanoid = char:FindFirstChildOfClass("Humanoid")
        if not humanoid then return end
        local ray = Ray.new(root.Position, Vector3.new(0, -500, 0))
        local hit, position = workspace:FindPartOnRay(ray, char)
        if hit then
            local groundY = position.Y
            local currentY = root.Position.Y
            if currentY - groundY > 0.5 then
                root.CFrame = CFrame.new(root.Position.X, groundY + 0.5, root.Position.Z)
                humanoid.PlatformStand = true
                humanoid.PlatformStand = false
            end
        end
    end)
end

local function softAntiLagAndSunset()
    pcall(function()
        local classesToClean = {["ParticleEmitter"]=true, ["Trail"]=true, ["Smoke"]=true, ["Fire"]=true}
        for _, obj in ipairs(workspace:GetChildren()) do
            if obj:IsA("Model") or obj:IsA("Part") then
                for _, sub in ipairs(obj:GetChildren()) do
                    if classesToClean[sub.ClassName] then
                        pcall(function() sub:Destroy() end)
                    end
                end
            end
        end
        local terrain = workspace:FindFirstChildOfClass("Terrain")
        if terrain then
            terrain.WaterWaveSize = 0
            terrain.WaterReflectance = 0
            terrain.WaterTransparency = 1
        end
    end)
    pcall(function()
        lighting.ClockTime = 18
        lighting.Brightness = 1.5
        lighting.OutdoorAmbient = Color3.fromRGB(150, 100, 80)
        lighting.FogColor = Color3.fromRGB(200, 120, 100)
        lighting.FogEnd = 500
        for _, v in ipairs(lighting:GetChildren()) do
            if v:IsA("Sky") then
                pcall(function() v:Destroy() end)
            end
        end
        local sky = Instance.new("Sky")
        sky.Name = "SunsetSky"
        sky.SkyboxBk = "rbxassetid://131889017"
        sky.SkyboxDn = "rbxassetid://131889017"
        sky.SkyboxFt = "rbxassetid://131889017"
        sky.SkyboxLf = "rbxassetid://131889017"
        sky.SkyboxRt = "rbxassetid://131889017"
        sky.SkyboxUp = "rbxassetid://131889017"
        sky.SunAngularSize = 10
        sky.MoonAngularSize = 0
        sky.SunTextureId = "rbxassetid://644432992"
        sky.Parent = lighting
    end)
end

local function hookResetOnCharacter(char)
    if not char then return end
    local humanoid = char:FindFirstChildOfClass("Humanoid")
    safeDisconnect("ResetDeath")
    connections.ResetDeath = humanoid.Died:Connect(function()
        task.wait(0.5)
        respawnPlayer()
    end)
end

local function startTinyIslandLoop()
    local id = "TinyIslandLoop"
    loops[id] = true
    task.spawn(function()
        local teleportPos = CFrame.new(-37.1, 9.2, 1919)
        while comboActive and loops[id] do
            pcall(function()
                local char = LocalPlayer.Character
                if char and char:FindFirstChild("HumanoidRootPart") then
                    char.HumanoidRootPart.CFrame = teleportPos
                end
            end)
            task.wait(0.2)
        end
    end)
end

-- Animation block & recovery
local function removePunchAnim()
    local blockedAnimations = {
        ["rbxassetid://3638729053"] = true,
        ["rbxassetid://3638767427"] = true,
    }

    local function setupAnimationBlocking()
        local char = game.Players.LocalPlayer.Character
        if not char or not char:FindFirstChild("Humanoid") then return end

        local humanoid = char:FindFirstChild("Humanoid")

        for _, track in pairs(humanoid:GetPlayingAnimationTracks()) do
            if track.Animation then
                local animId = track.Animation.AnimationId
                local animName = track.Name:lower()
                if blockedAnimations[animId] or animName:match("punch") or animName:match("attack") or animName:match("right") then
                    track:Stop()
                end
            end
        end

        if not _G.AnimBlockConnection then
            local connection = humanoid.AnimationPlayed:Connect(function(track)
                if track.Animation then
                    local animId = track.Animation.AnimationId
                    local animName = track.Name:lower()
                    if blockedAnimations[animId] or animName:match("punch") or animName:match("attack") or animName:match("right") then
                        track:Stop()
                    end
                end
            end)
            _G.AnimBlockConnection = connection
        end
    end

    setupAnimationBlocking()

    local function overrideToolActivation()
        local function processTool(tool)
            if tool and (tool.Name == "Punch" or tool.Name:match("Attack") or tool.Name:match("Right")) then
                if not tool:GetAttribute("ActivatedOverride") then
                    tool:SetAttribute("ActivatedOverride", true)
                    local connection = tool.Activated:Connect(function()
                        task.wait(0.05)
                        local char = game.Players.LocalPlayer.Character
                        if char and char:FindFirstChild("Humanoid") then
                            for _, track in pairs(char.Humanoid:GetPlayingAnimationTracks()) do
                                if track.Animation then
                                    local animId = track.Animation.AnimationId
                                    local animName = track.Name:lower()
                                    if blockedAnimations[animId] or animName:match("punch") or animName:match("attack") or animName:match("right") then
                                        track:Stop()
                                    end
                                end
                            end
                        end
                    end)
                    if not _G.ToolConnections then _G.ToolConnections = {} end
                    _G.ToolConnections[tool] = connection
                end
            end
        end

        for _, tool in pairs(game.Players.LocalPlayer.Backpack:GetChildren()) do
            processTool(tool)
        end

        local char = game.Players.LocalPlayer.Character
        if char then
            for _, tool in pairs(char:GetChildren()) do
                if tool:IsA("Tool") then
                    processTool(tool)
                end
            end
        end

        if not _G.BackpackAddedConnection then
            _G.BackpackAddedConnection = game.Players.LocalPlayer.Backpack.ChildAdded:Connect(function(child)
                if child:IsA("Tool") then
                    task.wait(0.1)
                    processTool(child)
                end
            end)
        end

        if not _G.CharacterToolAddedConnection and char then
            _G.CharacterToolAddedConnection = char.ChildAdded:Connect(function(child)
                if child:IsA("Tool") then
                    task.wait(0.1)
                    processTool(child)
                end
            end)
        end
    end

    overrideToolActivation()

    if not _G.AnimMonitorConnection then
        _G.AnimMonitorConnection = game:GetService("RunService").Heartbeat:Connect(function()
            if tick() % 0.5 < 0.01 then
                local char = game.Players.LocalPlayer.Character
                if char and char:FindFirstChild("Humanoid") then
                    for _, track in pairs(char.Humanoid:GetPlayingAnimationTracks()) do
                        if track.Animation then
                            local animId = track.Animation.AnimationId
                            local animName = track.Name:lower()
                            if blockedAnimations[animId] or animName:match("punch") or animName:match("attack") or animName:match("right") then
                                track:Stop()
                            end
                        end
                    end
                end
            end
        end)
    end

    if not _G.CharacterAddedConnection then
        _G.CharacterAddedConnection = game.Players.LocalPlayer.CharacterAdded:Connect(function(newChar)
            task.wait(1)
            setupAnimationBlocking()
            overrideToolActivation()
        end)
    end
end

local function RecoveryPunch()
    if _G.AnimBlockConnection then
        _G.AnimBlockConnection:Disconnect()
        _G.AnimBlockConnection = nil
    end
    if _G.AnimMonitorConnection then
        _G.AnimMonitorConnection:Disconnect()
        _G.AnimMonitorConnection = nil
    end
    if _G.ToolConnections then
        for _, conn in pairs(_G.ToolConnections) do
            if conn then conn:Disconnect() end
        end
        _G.ToolConnections = nil
    end
    if _G.BackpackAddedConnection then
        _G.BackpackAddedConnection:Disconnect()
        _G.BackpackAddedConnection = nil
    end
    if _G.CharacterToolAddedConnection then
        _G.CharacterToolAddedConnection:Disconnect()
        _G.CharacterToolAddedConnection = nil
    end
    if _G.CharacterAddedConnection then
        _G.CharacterAddedConnection:Disconnect()
        _G.CharacterAddedConnection = nil
    end
end

-- Pets helpers
local function getPetNames()
    local names = {}
    pcall(function()
        local petsFolder = LocalPlayer:WaitForChild("petsFolder", 1)
        if petsFolder then
            for _, folder in pairs(petsFolder:GetChildren()) do
                if folder:IsA("Folder") then
                    for _, pet in pairs(folder:GetChildren()) do
                        if not table.find(names, pet.Name) then
                            table.insert(names, pet.Name)
                        end
                    end
                end
            end
            if petsFolder:FindFirstChild("Unique") then
                for _, pet in pairs(petsFolder.Unique:GetChildren()) do
                    if not table.find(names, pet.Name) then
                        table.insert(names, pet.Name)
                    end
                end
            end
        end
    end)
    table.sort(names)
    return names
end

local function equipPetByName(petName)
    pcall(function()
        local petsFolder = LocalPlayer:WaitForChild("petsFolder")
        for _, folder in pairs(petsFolder:GetChildren()) do
            if folder:IsA("Folder") then
                for _, pet in pairs(folder:GetChildren()) do
                    ReplicatedStorage.rEvents.equipPetEvent:FireServer("unequipPet", pet)
                end
            end
        end
        task.wait(0.2)
        local petsToEquip = {}
        for _, pet in pairs(petsFolder.Unique:GetChildren()) do
            if pet.Name == petName then
                table.insert(petsToEquip, pet)
            end
        end
        local maxPets = 8
        local equippedCount = math.min(#petsToEquip, maxPets)
        for i = 1, equippedCount do
            ReplicatedStorage.rEvents.equipPetEvent:FireServer("equipPet", petsToEquip[i])
            task.wait(0.1)
        end
    end)
end

-- Combat toggles state
local autoPunchNoAnim = false
local fastHitActive = false
local autoPunchActive = false
local autoKill = false
local killTarget = false
local spying = false
local autoGoodKarma = false
local autoBadKarma = false
local godDamageActive = false

-- Auto punch functions
local function setAutoPunchNoAnim(state)
    autoPunchNoAnim = state
    if state then
        task.spawn(function()
            while autoPunchNoAnim do
                local punch = LocalPlayer.Backpack:FindFirstChild("Punch") or (LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Punch"))
                if punch then
                    if punch.Parent ~= LocalPlayer.Character then
                        punch.Parent = LocalPlayer.Character
                    end
                    LocalPlayer.muscleEvent:FireServer("punch", "rightHand")
                    LocalPlayer.muscleEvent:FireServer("punch", "leftHand")
                else
                    autoPunchNoAnim = false
                end
                task.wait(0.01)
            end
        end)
    end
end

local function setAutoPunch(state)
    fastHitActive = state
    if state then
        task.spawn(function()
            while fastHitActive do
                local punch = LocalPlayer.Backpack:FindFirstChild("Punch")
                if punch then
                    punch.Parent = LocalPlayer.Character
                    if punch:FindFirstChild("attackTime") then
                        punch.attackTime.Value = 0
                    end
                end
                task.wait(0.1)
            end
        end)
        task.spawn(function()
            while fastHitActive do
                local punch = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Punch")
                if punch then
                    punch:Activate()
                end
                task.wait(0.1)
            end
        end)
    else
        local punch = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Punch")
        if punch then
            punch.Parent = LocalPlayer.Backpack
        end
    end
end

local function setFastPunch(state)
    autoPunchActive = state
    if state then
        task.spawn(function()
            while autoPunchActive do
                local punch = LocalPlayer.Backpack:FindFirstChild("Punch")
                if punch then
                    punch.Parent = LocalPlayer.Character
                    if punch:FindFirstChild("attackTime") then
                        punch.attackTime.Value = 0
                    end
                end
                task.wait()
            end
        end)
        task.spawn(function()
            while autoPunchActive do
                local punch = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Punch")
                if punch then
                    punch:Activate()
                end
                task.wait()
            end
        end)
    else
        local punch = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Punch")
        if punch then
            punch.Parent = LocalPlayer.Backpack
        end
    end
end

-- Helper lists
local function buildTargetNamesList()
    local list = {}
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            table.insert(list, player.Name)
        end
    end
    table.sort(list)
    return list
end

local function buildDisplayNameList()
    local list = {}
    for _, plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer then
            table.insert(list, plr.DisplayName)
        end
    end
    table.sort(list)
    return list
end

-- UI: Single "Killer" tab with sections. Follow/teleport removed.
local Tab = Window:AddTab{ Title = "Killer", Icon = "rbxassetid://10734962068" }

-- Main Section
local Main = Tab:AddSection("Main")
Main:AddToggle("AutoPunchNoAnim", {
    Title = "Auto Punch [No Animation]",
    Default = false,
    Callback = function(v)
        setAutoPunchNoAnim(v)
        Library:Notify{ Title = "AutoPunchNoAnim", Content = tostring(v), Duration = 2 }
    end
})
Main:AddToggle("AutoPunch", {
    Title = "Auto Punch",
    Default = false,
    Callback = function(v)
        setAutoPunch(v)
        Library:Notify{ Title = "AutoPunch", Content = tostring(v), Duration = 2 }
    end
})
Main:AddToggle("FastPunch", {
    Title = "Fast Punch",
    Default = false,
    Callback = function(v)
        setFastPunch(v)
        Library:Notify{ Title = "FastPunch", Content = tostring(v), Duration = 2 }
    end
})
Main:AddButton({
    Title = "NaN Size (Invoke)",
    Callback = function()
        pcall(function()
            local args = {"changeSize", 0/0}
            ReplicatedStorage:WaitForChild("rEvents"):WaitForChild("changeSpeedSizeRemote"):InvokeServer(unpack(args))
            Library:Notify{ Title = "NaN Size", Content = "Invoked changeSize NaN", Duration = 2 }
        end)
    end
})
Main:AddButton({
    Title = "Remove Punch Anim",
    Callback = function()
        removePunchAnim()
        Library:Notify{ Title = "Animation", Content = "Punch animations blocked", Duration = 2 }
    end
})
Main:AddButton({
    Title = "Recover Punch Anim",
    Callback = function()
        RecoveryPunch()
        Library:Notify{ Title = "Animation", Content = "Recovered animation hooks", Duration = 2 }
    end
})

-- Pets Section
local Pets = Tab:AddSection("Pets")
local petNames = getPetNames()
Pets:AddDropdown("SelectPet", {
    Title = "Select Pet",
    Description = "Choose pet to equip",
    Values = petNames,
    Default = petNames[1] or "",
    Callback = function(choice)
        if choice and choice ~= "" then
            equipPetByName(choice)
            Library:Notify{ Title = "Pets", Content = "Equipping " .. choice, Duration = 2 }
        end
    end
})
Pets:AddButton({
    Title = "Refresh Pet List",
    Callback = function()
        petNames = getPetNames()
        if Pets:Get("SelectPet") and Pets:Get("SelectPet").UpdateOptions then
            Pets:Get("SelectPet").UpdateOptions(petNames)
        end
        Library:Notify{ Title = "Pets", Content = "Pet list refreshed", Duration = 2 }
    end
})

-- Combo Section
local Combo = Tab:AddSection("Combo")
Combo:AddToggle("OPPunchCombo", {
    Title = "OP Punch When Dead | Combo",
    Default = false,
    Callback = function(enabled)
        comboActive = enabled
        cleanupAll()
        if enabled then
            applySizeNaN()
            startAutoPunch()
            startProteinEggLogic()
            startAntiFly()
            softAntiLagAndSunset()
            startTinyIslandLoop()

            if LocalPlayer.Character then
                hookResetOnCharacter(LocalPlayer.Character)
            end
            safeDisconnect("CharacterAddedReset")
            connections.CharacterAddedReset = LocalPlayer.CharacterAdded:Connect(function(char)
                task.wait(0.5)
                hookResetOnCharacter(char)
            end)
        end
        Library:Notify{ Title = "Combo", Content = "OP Punch Combo: "..tostring(enabled), Duration = 2 }
    end
})

-- Targets Section (includes Kill Target dropdown)
local Targets = Tab:AddSection("Targets")
Targets:AddToggle("AutoWhitelistFriends", {
    Title = "Auto Whitelist Friends",
    Default = false,
    Callback = function(state)
        if state then
            for _, player in ipairs(Players:GetPlayers()) do
                if player ~= LocalPlayer and LocalPlayer:IsFriendsWith(player.UserId) then
                    playerWhitelist[player.Name] = true
                end
            end

            connections.FriendAdded = Players.PlayerAdded:Connect(function(player)
                if player ~= LocalPlayer and LocalPlayer:IsFriendsWith(player.UserId) then
                    playerWhitelist[player.Name] = true
                end
            end)
        else
            if connections.FriendAdded then
                safeDisconnect("FriendAdded")
            end
            for name in pairs(playerWhitelist) do
                local friend = Players:FindFirstChild(name)
                if friend and LocalPlayer:IsFriendsWith(friend.UserId) then
                    playerWhitelist[name] = nil
                end
            end
        end
        Library:Notify{ Title = "Whitelist", Content = "Auto whitelist state: "..tostring(state), Duration = 2 }
    end
})

Targets:AddInput("WhitelistName", {
    Title = "Whitelist",
    Description = "Player name to whitelist",
    Default = "",
    Callback = function(text)
        local target = Players:FindFirstChild(text)
        if target then
            playerWhitelist[target.Name] = true
            Library:Notify{ Title = "Whitelist", Content = "Whitelisted "..target.Name, Duration = 2 }
        end
    end
})
Targets:AddInput("UnWhitelistName", {
    Title = "UnWhitelist",
    Description = "Player name to remove whitelist",
    Default = "",
    Callback = function(text)
        local target = Players:FindFirstChild(text)
        if target then
            playerWhitelist[target.Name] = nil
            Library:Notify{ Title = "Whitelist", Content = "Removed "..target.Name, Duration = 2 }
        end
    end
})

-- Kill Target dropdown (adds players to kill list)
local targetOptions = buildTargetNamesList()
Targets:AddDropdown("KillTargetDropdown", {
    Title = "Select Kill Target",
    Description = "Add player to kill list",
    Values = targetOptions,
    Default = targetOptions[1] or "",
    Callback = function(name)
        if name and not table.find(targetPlayerNames, name) then
            table.insert(targetPlayerNames, name)
            Library:Notify{ Title = "Targets", Content = "Added kill target: "..name, Duration = 2 }
        end
    end
})

Targets:AddInput("RemoveTarget", {
    Title = "Remove Target",
    Description = "Remove player from target list",
    Default = "",
    Callback = function(name)
        for i, v in ipairs(targetPlayerNames) do
            if v == name then
                table.remove(targetPlayerNames, i)
                Library:Notify{ Title = "Targets", Content = "Removed target: "..name, Duration = 2 }
                break
            end
        end
    end
})

Targets:AddToggle("AutoKill", {
    Title = "Auto Kill (AoE)",
    Default = false,
    Callback = function(state)
        autoKill = state
        if state then
            task.spawn(function()
                while autoKill do
                    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
                    local rightHand = character:FindFirstChild("RightHand")
                    local leftHand = character:FindFirstChild("LeftHand")

                    local punch = LocalPlayer.Backpack:FindFirstChild("Punch")
                    if punch and not character:FindFirstChild("Punch") then
                        punch.Parent = character
                    end

                    if rightHand and leftHand then
                        for _, target in ipairs(Players:GetPlayers()) do
                            if target ~= LocalPlayer and not playerWhitelist[target.Name] then
                                local targetChar = target.Character
                                local rootPart = targetChar and targetChar:FindFirstChild("HumanoidRootPart")
                                if rootPart then
                                    pcall(function()
                                        firetouchinterest(rightHand, rootPart, 1)
                                        firetouchinterest(leftHand, rootPart, 1)
                                        firetouchinterest(rightHand, rootPart, 0)
                                        firetouchinterest(leftHand, rootPart, 0)
                                    end)
                                end
                            end
                        end
                    end

                    task.wait(0.05)
                end
            end)
        end
    end
})

Targets:AddToggle("StartKillTarget", {
    Title = "Start Kill Target",
    Default = false,
    Callback = function(state)
        killTarget = state
        if state then
            task.spawn(function()
                while killTarget do
                    local character = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()

                    local punch = LocalPlayer.Backpack:FindFirstChild("Punch")
                    if punch and not character:FindFirstChild("Punch") then
                        punch.Parent = character
                    end

                    local rightHand = character:WaitForChild("RightHand", 5)
                    local leftHand = character:WaitForChild("LeftHand", 5)

                    if rightHand and leftHand then
                        for _, name in ipairs(targetPlayerNames) do
                            local target = Players:FindFirstChild(name)
                            if target and target ~= LocalPlayer then
                                local rootPart = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
                                if rootPart then
                                    pcall(function()
                                        firetouchinterest(rightHand, rootPart, 1)
                                        firetouchinterest(leftHand, rootPart, 1)
                                        firetouchinterest(rightHand, rootPart, 0)
                                        firetouchinterest(leftHand, rootPart, 0)
                                    end)
                                end
                            end
                        end
                    end

                    task.wait(0.05)
                end
            end)
        end
    end
})

-- View & Camera Section: only Keep "View Target Player" dropdown and View Toggle
local View = Tab:AddSection("View")
local displayNames = buildDisplayNameList()
View:AddDropdown("SelectViewTarget", {
    Title = "Select View Target",
    Description = "Choose player to view (camera)",
    Values = displayNames,
    Default = displayNames[1] or "",
    Callback = function(selectedDisplayName)
        if selectedDisplayName and selectedDisplayName ~= "" then
            local target = nil
            for _, plr in ipairs(Players:GetPlayers()) do
                if plr.DisplayName == selectedDisplayName then
                    target = plr
                    break
                end
            end
            if target then
                targetPlayerName = target.Name
                Library:Notify{ Title = "View", Content = "Viewing "..target.Name, Duration = 2 }
            end
        end
    end
})

View:AddToggle("ViewPlayer", {
    Title = "View Player (Camera Follow)",
    Default = false,
    Callback = function(state)
        spying = state
        if not spying then
            local cam = workspace.CurrentCamera
            cam.CameraSubject = LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("Humanoid") or LocalPlayer
            Library:Notify{ Title = "Camera", Content = "Stopped following", Duration = 2 }
            return
        end
        task.spawn(function()
            while spying do
                local target = Players:FindFirstChild(targetPlayerName)
                if target and target ~= LocalPlayer then
                    local humanoid = target.Character and target.Character:FindFirstChild("Humanoid")
                    if humanoid then
                        workspace.CurrentCamera.CameraSubject = humanoid
                    end
                end
                task.wait(0.1)
            end
        end)
    end
})

-- Misc Section
local Misc = Tab:AddSection("Misc")
Misc:AddToggle("AutoGoodKarma", {
    Title = "Auto Good Karma",
    Default = false,
    Callback = function(state)
        autoGoodKarma = state
        if state then
            task.spawn(function()
                while autoGoodKarma do
                    local playerChar = LocalPlayer.Character
                    local rightHand = playerChar and playerChar:FindFirstChild("RightHand")
                    local leftHand = playerChar and playerChar:FindFirstChild("LeftHand")
                    if playerChar and rightHand and leftHand then
                        for _, target in ipairs(Players:GetPlayers()) do
                            if target ~= LocalPlayer then
                                local evilKarma = target:FindFirstChild("evilKarma")
                                local goodKarma = target:FindFirstChild("goodKarma")
                                if evilKarma and goodKarma and evilKarma:IsA("IntValue") and goodKarma:IsA("IntValue") and evilKarma.Value > goodKarma.Value then
                                    local rootPart = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
                                    if rootPart then
                                        firetouchinterest(rightHand, rootPart, 1)
                                        firetouchinterest(leftHand, rootPart, 1)
                                        firetouchinterest(rightHand, rootPart, 0)
                                        firetouchinterest(leftHand, rootPart, 0)
                                    end
                                end
                            end
                        end
                    end
                    task.wait(0.01)
                end
            end)
        end
    end
})
Misc:AddToggle("AutoBadKarma", {
    Title = "Auto Bad Karma",
    Default = false,
    Callback = function(state)
        autoBadKarma = state
        if state then
            task.spawn(function()
                while autoBadKarma do
                    local playerChar = LocalPlayer.Character
                    local rightHand = playerChar and playerChar:FindFirstChild("RightHand")
                    local leftHand = playerChar and playerChar:FindFirstChild("LeftHand")
                    if playerChar and rightHand and leftHand then
                        for _, target in ipairs(Players:GetPlayers()) do
                            if target ~= LocalPlayer then
                                local evilKarma = target:FindFirstChild("evilKarma")
                                local goodKarma = target:FindFirstChild("goodKarma")
                                if evilKarma and goodKarma and evilKarma:IsA("IntValue") and goodKarma:IsA("IntValue") and goodKarma.Value > evilKarma.Value then
                                    local rootPart = target.Character and target.Character:FindFirstChild("HumanoidRootPart")
                                    if rootPart then
                                        firetouchinterest(rightHand, rootPart, 1)
                                        firetouchinterest(leftHand, rootPart, 1)
                                        firetouchinterest(rightHand, rootPart, 0)
                                        firetouchinterest(leftHand, rootPart, 0)
                                    end
                                end
                            end
                        end
                    end
                    task.wait(0.01)
                end
            end)
        end
    end
})
Misc:AddToggle("AutoSlams", {
    Title = "Auto Slams (Ground Slam)",
    Default = false,
    Callback = function(state)
        godDamageActive = state
        if state then
            task.spawn(function()
                while godDamageActive do
                    local player = LocalPlayer
                    local groundSlam = player.Backpack:FindFirstChild("Ground Slam") or (player.Character and player.Character:FindFirstChild("Ground Slam"))
                    if groundSlam then
                        if groundSlam.Parent == player.Backpack then
                            groundSlam.Parent = player.Character
                        end
                        if groundSlam:FindFirstChild("attackTime") then
                            groundSlam.attackTime.Value = 0
                        end
                        player.muscleEvent:FireServer("slam")
                        groundSlam:Activate()
                    end
                    task.wait(0.1)
                end
            end)
        end
    end
})

-- Player add/remove handlers: update dropdowns (best-effort - depends on UI lib)
Players.PlayerAdded:Connect(function(player)
    if Targets:Get("KillTargetDropdown") and Targets:Get("KillTargetDropdown").UpdateOptions then
        Targets:Get("KillTargetDropdown").UpdateOptions(buildTargetNamesList())
    end
    if View:Get("SelectViewTarget") and View:Get("SelectViewTarget").UpdateOptions then
        View:Get("SelectViewTarget").UpdateOptions(buildDisplayNameList())
    end
    if Pets:Get("SelectPet") and Pets:Get("SelectPet").UpdateOptions then
        Pets:Get("SelectPet").UpdateOptions(getPetNames())
    end
end)

Players.PlayerRemoving:Connect(function(player)
    if Targets:Get("KillTargetDropdown") and Targets:Get("KillTargetDropdown").UpdateOptions then
        Targets:Get("KillTargetDropdown").UpdateOptions(buildTargetNamesList())
    end
    if View:Get("SelectViewTarget") and View:Get("SelectViewTarget").UpdateOptions then
        View:Get("SelectViewTarget").UpdateOptions(buildDisplayNameList())
    end
    if Pets:Get("SelectPet") and Pets:Get("SelectPet").UpdateOptions then
        Pets:Get("SelectPet").UpdateOptions(getPetNames())
    end

    for i = #targetPlayerNames, 1, -1 do
        if targetPlayerNames[i] == player.Name then
            table.remove(targetPlayerNames, i)
        end
    end
end)

-- Crystal Auto Buy (SpeedHub-style)
-- Converted from crystal_auto_buy.lua into a standalone SpeedHub UI using AddToggle/AddDropdown/AddButton API.
-- Do NOT add this into the Killer UI  it is a separate window/tab.

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer

-- Crystal data (kept from original)
local crystalData = {
    ["Blue Crystal"] = {
        {name = "Blue Birdie", rarity = "Basic"},
        {name = "Orange Hedgehog", rarity = "Basic"},
        {name = "Blue Aura", rarity = "Basic"},
        {name = "Red Kitty", rarity = "Basic"},
        {name = "Dark Vampy", rarity = "Advanced"},
        {name = "Blue Bunny", rarity = "Basic"},
        {name = "Red Aura", rarity = "Basic"},
        {name = "Blue Aura", rarity = "Basic"},
        {name = "Green Aura", rarity = "Basic"},
        {name = "Purple Aura", rarity = "Basic"},
        {name = "Red Aura", rarity = "Basic"},
        {name = "Yellow Aura", rarity = "Basic"}
    },
    ["Green Crystal"] = {
        {name = "Silver Dog", rarity = "Basic"},
        {name = "Green Aura", rarity = "Advanced"},
        {name = "Dark Golem", rarity = "Advanced"},
        {name = "Green Butterfly", rarity = "Advanced"},
        {name = "Crimson Falcon", rarity = "Rare"},
        {name = "Red Aura", rarity = "Basic"},
        {name = "Blue Aura", rarity = "Basic"},
        {name = "Green Aura", rarity = "Basic"},
        {name = "Purple Aura", rarity = "Basic"},
        {name = "Red Aura", rarity = "Basic"},
        {name = "Yellow Aura", rarity = "Basic"}
    },
    ["Frost Crystal"] = {
        {name = "Yellow Butterfly", rarity = "Advanced"},
        {name = "Purple Dragon", rarity = "Rare"},
        {name = "Blue Pheonix", rarity = "Epic"},
        {name = "Orange Pegasus", rarity = "Rare"},
        {name = "Lightning", rarity = "Rare"},
        {name = "Electro", rarity = "Advanced"}
    },
    ["Mythical Crystal"] = {
        {name = "Purple Falcon", rarity = "Rare"},
        {name = "Red Dragon", rarity = "Rare"},
        {name = "Blue Firecaster", rarity = "Epic"},
        {name = "Golden Pheonix", rarity = "Epic"},
        {name = "Power Lightning", rarity = "Rare"},
        {name = "Dark Lightning", rarity = "Epic"}
    },
    ["Inferno Crystal"] = {
        {name = "Red Firecaster", rarity = "Epic"},
        {name = "Infernal Dragon", rarity = "Unique"},
        {name = "White Pegasus", rarity = "Rare"},
        {name = "Golden Pheonix", rarity = "Epic"},
        {name = "Inferno", rarity = "Epic"},
        {name = "Dark Storm", rarity = "Unique"}
    },
    ["Legends Crystal"] = {
        {name = "Ultra Birdie", rarity = "Unique"},
        {name = "Magic Butterfly", rarity = "Unique"},
        {name = "Green Firecaster", rarity = "Epic"},
        {name = "White Pheonix", rarity = "Epic"},
        {name = "Supernova", rarity = "Epic"},
        {name = "Purple Nova", rarity = "Unique"}
    },
    ["Muscle Elite Crystal"] = {
        {name = "Frostwave Legends Penguin", rarity = "Rare"},
        {name = "Phantom Genesis Dragon", rarity = "Rare"},
        {name = "Dark Legends Manticore", rarity = "Epic"},
        {name = "Ultimate Supernova Pegasus", rarity = "Epic"},
        {name = "Aether Spirit Bunny", rarity = "Unique"},
        {name = "Cybernetic Showdown Dragon", rarity = "Unique"}
    },
    ["Galaxy Oracle Crystal"] = {
        {name = "Eternal Strike Leviathan", rarity = "Rare"},
        {name = "Lightning Strike Phantom", rarity = "Epic"},
        {name = "Darkstar Hunter", rarity = "Unique"},
        {name = "Muscle King", rarity = "Unique"},
        {name = "Azure Tundra", rarity = "Epic"},
        {name = "Ultra Inferno", rarity = "Rare"}
    },
    ["Jungle Crystal"] = {
        {name = "Entropic Blast", rarity = "Unique"},
        {name = "Muscle Sensei", rarity = "Unique"},
        {name = "Grand Supernova", rarity = "Epic"},
        {name = "Neon Guardian", rarity = "Unique"},
        {name = "Eternal Megastrike", rarity = "Unique"},
        {name = "Golden Viking", rarity = "Epic"},
        {name = "Astral Electro", rarity = "Epic"},
        {name = "Dark Electro", rarity = "Epic"},
        {name = "Enchanted Mirage", rarity = "Epic"},
        {name = "Ultra Mirage", rarity = "Unique"},
        {name = "Unstable Mirage", rarity = "Unique"}
    }
}

-- Helpers: collect all unique pets and auras and find crystal
local function getAllPetsAndAuras()
    local allPets = {}
    local allAuras = {}
    for crystalName, pets in pairs(crystalData) do
        for _, pet in ipairs(pets) do
            if string.find(pet.name, "Aura") then
                if not allAuras[pet.name] then
                    allAuras[pet.name] = {name = pet.name, rarity = pet.rarity, crystal = crystalName}
                end
            else
                if not allPets[pet.name] then
                    allPets[pet.name] = {name = pet.name, rarity = pet.rarity, crystal = crystalName}
                end
            end
        end
    end
    return allPets, allAuras
end

local function findCrystalForItem(itemName)
    for crystalName, pets in pairs(crystalData) do
        for _, pet in ipairs(pets) do
            if pet.name == itemName then
                return crystalName
            end
        end
    end
    return nil
end

-- Build dropdown lists (the original script uses manual sorted lists)
local petList = {
    -- Basic
    "Blue Birdie (Basic)",
    "Orange Hedgehog (Basic)",
    "Red Kitty (Basic)",
    "Blue Bunny (Basic)",
    "Silver Dog (Basic)",
    -- Advanced
    "Dark Vampy (Advanced)",
    "Dark Golem (Advanced)",
    "Green Butterfly (Advanced)",
    "Yellow Butterfly (Advanced)",
    -- Rare
    "Crimson Falcon (Rare)",
    "Purple Dragon (Rare)",
    "Orange Pegasus (Rare)",
    "Purple Falcon (Rare)",
    "Red Dragon (Rare)",
    "White Pegasus (Rare)",
    "Frostwave Legends Penguin (Rare)",
    "Phantom Genesis Dragon (Rare)",
    "Eternal Strike Leviathan (Rare)",
    -- Epic
    "Blue Pheonix (Epic)",
    "Blue Firecaster (Epic)",
    "Golden Pheonix (Epic)",
    "Red Firecaster (Epic)",
    "Green Firecaster (Epic)",
    "White Pheonix (Epic)",
    "Dark Legends Manticore (Epic)",
    "Ultimate Supernova Pegasus (Epic)",
    "Lightning Strike Phantom (Epic)",
    "Golden Viking (Epic)",
    -- Unique
    "Infernal Dragon (Unique)",
    "Ultra Birdie (Unique)",
    "Magic Butterfly (Unique)",
    "Aether Spirit Bunny (Unique)",
    "Cybernetic Showdown Dragon (Unique)",
    "Darkstar Hunter (Unique)",
    "Muscle Sensei (Unique)",
    "Neon Guardian (Unique)",
}

local auraList = {
    "Blue Aura (Basic)",
    "Green Aura (Basic)",
    "Purple Aura (Basic)",
    "Red Aura (Basic)",
    "Yellow Aura (Basic)",
    -- extras included in original file as aura-like options
    "Ultra Inferno  (Rare)",
    "Azure Tundra (Epic)",
    "Grand Supernova (Epic)",
    "Muscle King (Unique)",
    "Entropic Blast (Unique)",
    "Eternal Megastrike (Unique)"
}

local ultimateOptions = {
    "+1 Daily Spin",
    "+1 Pet Slot",
    "+10 Item Capacity",
    "+5% Rep Speed",
    "Demon Damage",
    "Galaxy Gains",
    "Golden Rebirth",
    "Jungle Swift",
    "Muscle Mind",
    "x2 Chest Rewards",
    "x2 Quest Rewards"
}

local Tab = Window:AddTab{ Title = "Shop", Icon = "gem" }
local ShopSection = Tab:AddSection("Aura & Pet Shop")

-- Selected items tracking
local selectedPet = ""
local selectedAura = ""
local selectedUltimate = ""

-- Pet dropdown (SpeedHub style)
ShopSection:AddDropdown("SelectPet", {
    Title = "Select pet",
    Description = "Choose which pet to auto-buy",
    Values = petList,
    Default = petList[1],
    Callback = function(value)
        selectedPet = value or ""
        Library:Notify{ Title = "Pet Selected", Content = tostring(selectedPet), Duration = 2 }
    end
})

-- Aura dropdown
ShopSection:AddDropdown("SelectAura", {
    Title = "Select aura",
    Description = "Choose which aura to auto-buy",
    Values = auraList,
    Default = auraList[1],
    Callback = function(value)
        selectedAura = value or ""
        Library:Notify{ Title = "Aura Selected", Content = tostring(selectedAura), Duration = 2 }
    end
})

-- Auto-buy section
local AutoSection = Tab:AddSection("Auto Buy")

-- Helper to extract name (removes trailing " (Rarity)" if present)
local function stripRarity(s)
    if not s or s == "" then return s end
    local name = s:match("^(.-)%s*%(")
    if name and name ~= "" then
        return name
    end
    return s
end

-- Auto Buy Pet toggle (SpeedHub AddToggle)
AutoSection:AddToggle("AutoBuyPet", {
    Title = "Auto Buy Pet",
    Default = false,
    Callback = function(state)
        _G.AutoBuyPet = state
        if state then
            if selectedPet == "" or not selectedPet then
                Library:Notify{ Title = "Auto Buy Pet", Content = "Please select a pet first", Duration = 3 }
                _G.AutoBuyPet = false
                return
            end

            local petName = stripRarity(selectedPet)
            local crystal = findCrystalForItem(petName)
            if not crystal then
                Library:Notify{ Title = "Auto Buy Pet", Content = "Could not find crystal for: "..petName, Duration = 3 }
                _G.AutoBuyPet = false
                return
            end

            Library:Notify{ Title = "Auto Buy Pet", Content = "Started auto-buy for "..petName.." ("..crystal..")", Duration = 3 }
            spawn(function()
                while _G.AutoBuyPet do
                    local ok, err = pcall(function()
                        local petToBuy = ReplicatedStorage:FindFirstChild("cPetShopFolder") and ReplicatedStorage.cPetShopFolder:FindFirstChild(petName)
                        if petToBuy then
                            -- original used InvokeServer with object; keep same behavior but guarded
                            if ReplicatedStorage:FindFirstChild("cPetShopRemote") and ReplicatedStorage.cPetShopRemote.InvokeServer then
                                ReplicatedStorage.cPetShopRemote:InvokeServer(petToBuy)
                            end
                        end
                    end)
                    if not ok then
                        warn("AutoBuyPet error:", err)
                    end
                    task.wait(0.1)
                end
            end)
        else
            Library:Notify{ Title = "Auto Buy Pet", Content = "Stopped", Duration = 2 }
        end
    end
})

-- Auto Buy Aura toggle
AutoSection:AddToggle("AutoBuyAura", {
    Title = "Auto Buy Aura",
    Default = false,
    Callback = function(state)
        _G.AutoBuyAura = state
        if state then
            if selectedAura == "" or not selectedAura then
                Library:Notify{ Title = "Auto Buy Aura", Content = "Please select an aura first", Duration = 3 }
                _G.AutoBuyAura = false
                return
            end

            local auraName = stripRarity(selectedAura)
            local crystal = findCrystalForItem(auraName)
            if not crystal then
                Library:Notify{ Title = "Auto Buy Aura", Content = "Could not find crystal for: "..auraName, Duration = 3 }
                _G.AutoBuyAura = false
                return
            end

            Library:Notify{ Title = "Auto Buy Aura", Content = "Started auto-buy for "..auraName.." ("..crystal..")", Duration = 3 }
            spawn(function()
                while _G.AutoBuyAura do
                    local ok, err = pcall(function()
                        local auraToBuy = ReplicatedStorage:FindFirstChild("cPetShopFolder") and ReplicatedStorage.cPetShopFolder:FindFirstChild(auraName)
                        if auraToBuy then
                            if ReplicatedStorage:FindFirstChild("cPetShopRemote") and ReplicatedStorage.cPetShopRemote.InvokeServer then
                                ReplicatedStorage.cPetShopRemote:InvokeServer(auraToBuy)
                            end
                        end
                    end)
                    if not ok then
                        warn("AutoBuyAura error:", err)
                    end
                    task.wait(0.1)
                end
            end)
        else
            Library:Notify{ Title = "Auto Buy Aura", Content = "Stopped", Duration = 2 }
        end
    end
})

-- Ultimates section
local UltSection = Tab:AddSection("K13 Auto Buy Ultimates")

UltSection:AddDropdown("SelectUltimate", {
    Title = "Select ultimate",
    Description = "Choose which ultimate to upgrade/buy",
    Values = ultimateOptions,
    Default = ultimateOptions[1],
    Callback = function(value)
        selectedUltimate = value or ""
        Library:Notify{ Title = "Ultimate Selected", Content = tostring(selectedUltimate), Duration = 2 }
    end
})

UltSection:AddToggle("AutoBuyUltimates", {
    Title = "Auto Buy Ultimates",
    Default = false,
    Callback = function(state)
        _G.AutoUpgradeUltimate = state
        if state then
            if selectedUltimate == "" or not selectedUltimate then
                Library:Notify{ Title = "Auto Buy Ultimates", Content = "Please select an ultimate first", Duration = 3 }
                _G.AutoUpgradeUltimate = false
                return
            end

            Library:Notify{ Title = "Auto Buy Ultimates", Content = "Started auto-upgrade for "..selectedUltimate, Duration = 3 }
            spawn(function()
                while _G.AutoUpgradeUltimate do
                    local ok, err = pcall(function()
                        if ReplicatedStorage:FindFirstChild("rEvents") and ReplicatedStorage.rEvents:FindFirstChild("ultimatesRemote") then
                            ReplicatedStorage.rEvents.ultimatesRemote:InvokeServer("upgradeUltimate", selectedUltimate)
                        end
                    end)
                    if not ok then
                        warn("AutoUpgradeUltimate error:", err)
                    end
                    task.wait(1)
                end
            end)
        else
            Library:Notify{ Title = "Auto Buy Ultimates", Content = "Stopped", Duration = 2 }
        end
    end
})

-- Utility: Refresh dropdowns (in case you want to programmatically update later)
local function RefreshPetDropdown()
    local section = ShopSection
    if section and section:Get("SelectPet") and section:Get("SelectPet").UpdateOptions then
        section:Get("SelectPet").UpdateOptions(petList)
    end
end

local function RefreshAuraDropdown()
    local section = ShopSection
    if section and section:Get("SelectAura") and section:Get("SelectAura").UpdateOptions then
        section:Get("SelectAura").UpdateOptions(auraList)
    end
end

local function RefreshUltimateDropdown()
    local section = UltSection
    if section and section:Get("SelectUltimate") and section:Get("SelectUltimate").UpdateOptions then
        section:Get("SelectUltimate").UpdateOptions(ultimateOptions)
    end
end

-- Ensure some globals exist to avoid nil indexing
getgenv().autoFarm = getgenv().autoFarm or false
_G.AutoPushups = _G.AutoPushups or false
_G.AutoSitups = _G.AutoSitups or false
_G.AutoHandstands = _G.AutoHandstands or false
local autoPunchNoAnim = autoPunchNoAnim or false
local selectrock = selectrock or ""

local AutoRockTab = Window:AddTab{ Title = "Auto Rock", Icon = "mountain" }

local UnifiedSection = AutoRockTab:AddSection("Unified Toggles")
local RocksSection = AutoRockTab:AddSection("Rocks")

-- Helper to safely get player and character
local function getPlayer()
    local Players = game:GetService("Players")
    return Players.LocalPlayer
end

-- Helper: attempt to run gettool if exists
local function tryGetTool()
    if typeof(gettool) == "function" then
        pcall(gettool)
    end
end

-- Auto Punch helper (no animation combo)
local function doAutoPunch(player, character)
    if not player or not character then return end
    -- Try to get the Punch tool from backpack or character
    local punchTool = player.Backpack:FindFirstChild("Punch") or character:FindFirstChild("Punch")
    if punchTool then
        -- Ensure tool is in character to allow punching events
        if punchTool.Parent ~= character then
            punchTool.Parent = character
        end
        pcall(function()
            if player.muscleEvent then
                -- send both hand punch events; keep it lightweight like original script
                player.muscleEvent:FireServer("punch", "rightHand")
                player.muscleEvent:FireServer("punch", "leftHand")
            end
        end)
    else
        -- If not found repeatedly, disable punching to avoid spamming warnings
        -- (we leave the main toggle active for rock interactions)
        warn("Punch tool not found; disabling auto-punch for now.")
        -- don't mutate external state besides local autoPunchNoAnim
        -- but keep functions robust
    end
end

-- Unified toggle: Pushups + Jungle Rock + Auto Punch (No Animation)
UnifiedSection:AddToggle("Pushups + Jungle Rock", {
    Title = "Pushups + Jungle Rock",
    Default = false,
    Description = "",
    Callback = function(state)
        getgenv().autoFarm = state
        _G.AutoPushups = state
        autoPunchNoAnim = state
        selectrock = "Ancient Jungle Rock"

        task.spawn(function()
            while getgenv().autoFarm do
                task.wait(0.01)
                if not getgenv().autoFarm then break end

                local player = getPlayer()
                if not player then continue end
                local character = player.Character
                if not character then continue end

                -- Auto equip Pushups tool
                if _G.AutoPushups then
                    local pushupsTool = player.Backpack:FindFirstChild("Pushups") or character:FindFirstChild("Pushups")
                    if pushupsTool and character:FindFirstChild("Humanoid") then
                        character.Humanoid:EquipTool(pushupsTool)
                    end
                    pcall(function()
                        if player.muscleEvent then
                            player.muscleEvent:FireServer("rep")
                        end
                    end)
                end

                -- Auto Punch (No Animation) combo
                if autoPunchNoAnim then
                    doAutoPunch(player, character)
                end

                -- Jungle Rock interaction if Durability >= 10,000,000
                if player:FindFirstChild("Durability") and player.Durability.Value >= 10000000 then
                    for _, v in pairs(game.Workspace.machinesFolder:GetDescendants()) do
                        if v.Name == "neededDurability" and v.Value == 10000000 and character:FindFirstChild("LeftHand") and character:FindFirstChild("RightHand") then
                            if v.Parent and v.Parent:FindFirstChild("Rock") then
                                firetouchinterest(v.Parent.Rock, character.RightHand, 0)
                                firetouchinterest(v.Parent.Rock, character.RightHand, 1)
                                firetouchinterest(v.Parent.Rock, character.LeftHand, 0)
                                firetouchinterest(v.Parent.Rock, character.LeftHand, 1)
                                tryGetTool()
                            end
                        end
                    end
                end
            end
        end)
    end
})

-- Unified toggle: Auto Situps + Jungle Rock + Auto Punch (No Animation)
UnifiedSection:AddToggle("Auto Situps + Jungle Rock", {
    Title = "Auto Situps + Jungle Rock",
    Default = false,
    Description = "",
    Callback = function(state)
        getgenv().autoFarm = state
        _G.AutoSitups = state
        autoPunchNoAnim = state
        selectrock = "Ancient Jungle Rock"

        task.spawn(function()
            while getgenv().autoFarm do
                task.wait(0.01)
                if not getgenv().autoFarm then break end

                local player = getPlayer()
                if not player then continue end
                local character = player.Character
                if not character then continue end

                -- Auto equip Situps tool
                if _G.AutoSitups then
                    local situpsTool = player.Backpack:FindFirstChild("Situps") or character:FindFirstChild("Situps")
                    if situpsTool and character:FindFirstChild("Humanoid") then
                        character.Humanoid:EquipTool(situpsTool)
                    end
                    pcall(function()
                        if player.muscleEvent then
                            player.muscleEvent:FireServer("rep")
                        end
                    end)
                end

                -- Auto Punch (No Animation) combo
                if autoPunchNoAnim then
                    doAutoPunch(player, character)
                end

                -- Jungle Rock interaction if Durability >= 10,000,000
                if player:FindFirstChild("Durability") and player.Durability.Value >= 10000000 then
                    for _, v in pairs(game.Workspace.machinesFolder:GetDescendants()) do
                        if v.Name == "neededDurability" and v.Value == 10000000 and character:FindFirstChild("LeftHand") and character:FindFirstChild("RightHand") then
                            if v.Parent and v.Parent:FindFirstChild("Rock") then
                                firetouchinterest(v.Parent.Rock, character.RightHand, 0)
                                firetouchinterest(v.Parent.Rock, character.RightHand, 1)
                                firetouchinterest(v.Parent.Rock, character.LeftHand, 0)
                                firetouchinterest(v.Parent.Rock, character.LeftHand, 1)
                                tryGetTool()
                            end
                        end
                    end
                end
            end
        end)
    end
})

-- Unified toggle: Auto Handstands + Jungle Rock + Auto Punch (No Animation)
UnifiedSection:AddToggle("Handstands + Jungle Rock", {
    Title = "Handstands + Jungle Rock",
    Default = false,
    Description = "",
    Callback = function(state)
        getgenv().autoFarm = state
        _G.AutoHandstands = state
        autoPunchNoAnim = state
        selectrock = "Ancient Jungle Rock"

        task.spawn(function()
            while getgenv().autoFarm do
                task.wait(0.01)
                if not getgenv().autoFarm then break end

                local player = getPlayer()
                if not player then continue end
                local character = player.Character
                if not character then continue end

                -- Auto equip Handstand tool
                if _G.AutoHandstands then
                    local handstandTool = player.Backpack:FindFirstChild("Handstands") or character:FindFirstChild("Handstands")
                    if handstandTool and character:FindFirstChild("Humanoid") then
                        character.Humanoid:EquipTool(handstandTool)
                    end
                    pcall(function()
                        if player.muscleEvent then
                            player.muscleEvent:FireServer("rep")
                        end
                    end)
                end

                -- Auto Punch (No Animation) combo
                if autoPunchNoAnim then
                    doAutoPunch(player, character)
                end

                -- Jungle Rock interaction if Durability >= 10,000,000
                if player:FindFirstChild("Durability") and player.Durability.Value >= 10000000 then
                    for _, v in pairs(game.Workspace.machinesFolder:GetDescendants()) do
                        if v.Name == "neededDurability" and v.Value == 10000000 and character:FindFirstChild("LeftHand") and character:FindFirstChild("RightHand") then
                            if v.Parent and v.Parent:FindFirstChild("Rock") then
                                firetouchinterest(v.Parent.Rock, character.RightHand, 0)
                                firetouchinterest(v.Parent.Rock, character.RightHand, 1)
                                firetouchinterest(v.Parent.Rock, character.LeftHand, 0)
                                firetouchinterest(v.Parent.Rock, character.LeftHand, 1)
                                tryGetTool()
                            end
                        end
                    end
                end
            end
        end)
    end
})

-- Rocks section: each label converted to a toggle. Each toggle runs rock interaction + Auto Punch combo
local function addRockToggle(name, requiredDurability, rockParentName)
    -- rockParentName is optional; if nil, unchanged logic will use v.Parent.Rock as before
    RocksSection:AddToggle(name, {
        Title = name,
        Default = false,
        Description = "",
        Callback = function(Value)
            selectrock = rockParentName or selectrock
            getgenv().autoFarm = Value

            task.spawn(function()
                while getgenv().autoFarm do
                    task.wait()
                    if not getgenv().autoFarm then break end

                    local player = getPlayer()
                    if not player then continue end
                    if not player:FindFirstChild("Durability") then continue end
                    local character = player.Character
                    if not character then continue end

                    -- Auto Punch combo runs regardless (will no-op if no Punch tool)
                    doAutoPunch(player, character)

                    if player.Durability.Value >= requiredDurability then
                        for _, v in pairs(game:GetService("Workspace").machinesFolder:GetDescendants()) do
                            if v.Name == "neededDurability" and v.Value == requiredDurability and character:FindFirstChild("LeftHand") and character:FindFirstChild("RightHand") then
                                if v.Parent and v.Parent:FindFirstChild("Rock") then
                                    firetouchinterest(v.Parent.Rock, character.RightHand, 0)
                                    firetouchinterest(v.Parent.Rock, character.RightHand, 1)
                                    firetouchinterest(v.Parent.Rock, character.LeftHand, 0)
                                    firetouchinterest(v.Parent.Rock, character.LeftHand, 1)
                                    tryGetTool()
                                end
                            end
                        end
                    end
                end
            end)
        end
    })
end

-- Add rock toggles with associated required durability values and names
addRockToggle("Jungle Rock", 10000000, "Ancient Jungle Rock")
addRockToggle("Muscle King Rock", 5000000, "Muscle King Gym Rock")
addRockToggle("Legend Rock", 1000000, "Legend Gym Rock")
addRockToggle("Eternal Rock", 750000, "Eternal Gym Rock")
addRockToggle("Mythical Rock", 400000, "Mythical Gym Rock")
addRockToggle("Frozen Rock", 150000, "Frost Gym Rock")
addRockToggle("Legend Beach Rock", 5000, "Legend Beach Rock")
addRockToggle("Starter Rock", 100, "Starter Island Rock")
addRockToggle("Tiny Rock", 0, "Tiny Island Rock")

local MiscTab = Window:AddTab{
    Title = "Miscellaneous",
    Icon = "cog"
}

-- Anti AFK
local antiAFKEnabled = true
local antiAFKConnection

local function setupAntiAFK()
    if antiAFKConnection then return end
    local vu = game:GetService("VirtualUser")
    antiAFKConnection = game.Players.LocalPlayer.Idled:Connect(function()
        vu:Button2Down(Vector2.new(), workspace.CurrentCamera.CFrame)
        task.wait(1)
        vu:Button2Up(Vector2.new(), workspace.CurrentCamera.CFrame)
    end)
end

if antiAFKEnabled then
    setupAntiAFK()
end

MiscTab:AddToggle("AntiAFK", {
    Title = "Anti AFK",
    Default = true,
    Callback = function(bool)
        antiAFKEnabled = bool
        if bool then
            setupAntiAFK()
        else
            if antiAFKConnection then
                antiAFKConnection:Disconnect()
                antiAFKConnection = nil
            end
        end
    end
})

-- Walk on Water
local parts = {}
local partSize = 2048
local totalDistance = 50000
local startPosition = Vector3.new(-2, -9.5, -2)
local numberOfParts = math.ceil(totalDistance / partSize)

local function createParts()
    for x = 0, numberOfParts - 1 do
        for z = 0, numberOfParts - 1 do
            local positions = {
                Vector3.new(x, 0, z),
                Vector3.new(-x, 0, z),
                Vector3.new(-x, 0, -z),
                Vector3.new(x, 0, -z),
            }
            for _, offset in ipairs(positions) do
                local p = Instance.new("Part")
                p.Size = Vector3.new(partSize, 1, partSize)
                p.Position = startPosition + Vector3.new(offset.X * partSize, offset.Y, offset.Z * partSize)
                p.Anchored = true
                p.Transparency = 1
                p.CanCollide = true
                p.Parent = workspace
                table.insert(parts, p)
            end
        end
    end
end

local function makePartsWalkthrough()
    for _, p in ipairs(parts) do
        if p and p.Parent then p.CanCollide = false end
    end
end

MiscTab:AddToggle("WalkOnWater", {
    Title = "Walk On Water",
    Default = false,
    Callback = function(state)
        if state then
            createParts()
        else
            makePartsWalkthrough()
        end
    end
})

-- Hide Pets
MiscTab:AddToggle("HidePets", {
    Title = "Hide Pets",
    Default = false,
    Callback = function(state)
        local event = game:GetService("ReplicatedStorage").rEvents.showPetsEvent
        if state then
            event:FireServer("hidePets")
        else
            event:FireServer("showPets")
        end
    end
})

-- Disable Trades
MiscTab:AddToggle("DisableTrades", {
    Title = "Disable Trades",
    Default = false,
    Callback = function(state)
        local event = game:GetService("ReplicatedStorage").rEvents.tradingEvent
        if state then
            event:FireServer("disableTrading")
        else
            event:FireServer("enableTrading")
        end
    end
})

-- Infinite Jump
local infJumpEnabled = false
local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local humanoid = character:WaitForChild("Humanoid")

player.CharacterAdded:Connect(function(char)
    character = char
    humanoid = char:WaitForChild("Humanoid")
end)

game:GetService("UserInputService").JumpRequest:Connect(function()
    if infJumpEnabled and humanoid then
        humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
    end
end)

MiscTab:AddToggle("InfJump", {
    Title = "Infinite Jump",
    Default = false,
    Callback = function(state)
        infJumpEnabled = state
    end
})

-- No Clip
MiscTab:AddToggle("NoClip", {
    Title = "No Clip",
    Default = false,
    Callback = function(state)
        _G.NoClip = state
        if state then
            local conn
            conn = game:GetService("RunService").Stepped:Connect(function()
                if _G.NoClip then
                    for _, part in pairs(player.Character:GetDescendants()) do
                        if part:IsA("BasePart") then part.CanCollide = false end
                    end
                else
                    conn:Disconnect()
                end
            end)
        end
    end
})

-- Anti Knockback
MiscTab:AddToggle("AntiKnockback", {
    Title = "Anti Knockback",
    Default = false,
    Callback = function(state)
        local root = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if not root then return end
        if state then
            local bv = Instance.new("BodyVelocity")
            bv.MaxForce = Vector3.new(100000, 0, 100000)
            bv.Velocity = Vector3.new(0, 0, 0)
            bv.P = 1250
            bv.Parent = root
        else
            local bv = root:FindFirstChildOfClass("BodyVelocity")
            if bv then bv:Destroy() end
        end
    end
})

-- Lock Position
MiscTab:AddToggle("LockPosition", {
    Title = "Lock Position",
    Default = false,
    Callback = function(state)
        if state then
            local currentPos = player.Character.HumanoidRootPart.CFrame
            getgenv().posLock = game:GetService("RunService").Heartbeat:Connect(function()
                if player.Character:FindFirstChild("HumanoidRootPart") then
                    player.Character.HumanoidRootPart.CFrame = currentPos
                end
            end)
        else
            if getgenv().posLock then
                getgenv().posLock:Disconnect()
                getgenv().posLock = nil
            end
        end
    end
})

local player = game.Players.LocalPlayer
local leaderstats = player:WaitForChild("leaderstats")
local strengthStat = leaderstats:WaitForChild("Strength")
local rebirthsStat = leaderstats:WaitForChild("Rebirths")
local durabilityStat = player:WaitForChild("Durability")
local killsStat = leaderstats:WaitForChild("Kills")
local agilityStat = player:WaitForChild("Agility")
local evilKarmaStat = player:WaitForChild("evilKarma")
local goodKarmaStat = player:WaitForChild("goodKarma")
local brawlsStat = leaderstats:WaitForChild("Brawls")

--// Helper function
local function AbbrevNumber(num)
    local abbrev = {"", "K", "M", "B", "T", "Qa", "Qi"}
    local i = 1
    while num >= 1000 and i < #abbrev do
        num = num / 1000
        i = i + 1
    end
    return string.format("%.2f%s", num, abbrev[i])
end

--// GUI Creation
local screenGui = Instance.new("ScreenGui")
screenGui.Parent = player:WaitForChild("PlayerGui")
screenGui.Name = "StatsUI"
screenGui.Enabled = false -- start hidden

local mainFrame = Instance.new("Frame")
mainFrame.Size = UDim2.new(0, 500, 0, 350)
mainFrame.Position = UDim2.new(0.5, -250, 0.5, -175)
mainFrame.BackgroundColor3 = Color3.fromRGB(20, 20, 20)
mainFrame.BorderSizePixel = 0
mainFrame.Parent = screenGui

-- Draggable title bar
local titleBar = Instance.new("Frame")
titleBar.Size = UDim2.new(1, 0, 0, 30)
titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 35)
titleBar.Parent = mainFrame

local titleLabel = Instance.new("TextLabel")
titleLabel.Size = UDim2.new(1, 0, 1, 0)
titleLabel.BackgroundTransparency = 1
titleLabel.Text = "Session Stats"
titleLabel.TextColor3 = Color3.fromRGB(0, 255, 0)
titleLabel.Font = Enum.Font.SourceSansBold
titleLabel.TextSize = 20
titleLabel.Parent = titleBar

mainFrame.Active = true
mainFrame.Draggable = true

-- Scrollable container
local scrollFrame = Instance.new("ScrollingFrame")
scrollFrame.Size = UDim2.new(1, 0, 1, -30)
scrollFrame.Position = UDim2.new(0, 0, 0, 30)
scrollFrame.CanvasSize = UDim2.new(0, 0, 0, 0)
scrollFrame.ScrollBarThickness = 8
scrollFrame.BackgroundTransparency = 1
scrollFrame.Parent = mainFrame

local uiListLayout = Instance.new("UIListLayout")
uiListLayout.SortOrder = Enum.SortOrder.LayoutOrder
uiListLayout.Padding = UDim.new(0, 5)
uiListLayout.Parent = scrollFrame

--// Add Labels helper
local function AddLabel(text, textSize)
    local label = Instance.new("TextLabel")
    label.Size = UDim2.new(1, -10, 0, textSize + 5)
    label.BackgroundTransparency = 1
    label.Text = text
    label.TextColor3 = Color3.fromRGB(0, 255, 0)
    label.Font = Enum.Font.SourceSans
    label.TextSize = textSize
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = scrollFrame
    return label
end

--// Add Button helper
local function AddButton(text, callback)
    local button = Instance.new("TextButton")
    button.Size = UDim2.new(1, -10, 0, 30)
    button.BackgroundColor3 = Color3.fromRGB(0, 50, 0)
    button.TextColor3 = Color3.fromRGB(0, 255, 0)
    button.Font = Enum.Font.SourceSansBold
    button.TextSize = 18
    button.Text = text
    button.Parent = scrollFrame
    button.MouseButton1Click:Connect(callback)
    return button
end

--// Create UI
AddLabel(" Session Statistics", 24)
local stopwatchLabel = AddLabel("Session Time: 0d 0h 0m 0s", 18)
local customTimerLabel = AddLabel("Custom Timer: Not started", 18)

local isCustomRunning = false
local customStart = 0
local customElapsed = 0

AddButton("Start/Stop Custom Timer", function()
    if not isCustomRunning then
        isCustomRunning = true
        customStart = tick() - customElapsed
    else
        isCustomRunning = false
        customElapsed = tick() - customStart
    end
end)

AddButton("Reset Custom Timer", function()
    isCustomRunning = false
    customStart = 0
    customElapsed = 0
    customTimerLabel.Text = "Custom Timer: Not started"
end)

local resetSession = false
AddButton("Reset Session Stats", function()
    resetSession = true
end)

AddLabel("------------------", 14)
AddLabel("Projected Stats", 24)
local projectedStrengthLabel = AddLabel("Strength Pace: -", 18)
local projectedDurabilityLabel = AddLabel("Durability Pace: -", 18)
local projectedRebirthsLabel = AddLabel("Rebirth Pace: -", 18)

AddLabel("------------------", 14)
AddLabel("Leaderboard Stats", 24)
local strengthLabel = AddLabel("Strength: -", 18)
local rebirthsLabel = AddLabel("Rebirths: -", 18)
local killsLabel = AddLabel("Kills: -", 18)
local brawlsLabel = AddLabel("Brawls: -", 18)

AddLabel("------------------", 14)
AddLabel("Player Stats", 24)
local goodKarmaLabel = AddLabel("Good Karma: -", 18)
local evilKarmaLabel = AddLabel("Evil Karma: -", 18)
local durabilityLabel = AddLabel("Durability: -", 18)
local agilityLabel = AddLabel("Agility: -", 18)

--// Initial Stats
local startTime = tick()
local initialStrength = strengthStat.Value
local initialDurability = durabilityStat.Value
local initialRebirths = rebirthsStat.Value
local initialKills = killsStat.Value
local initialAgility = agilityStat.Value
local initialEvilKarma = evilKarmaStat.Value
local initialGoodKarma = goodKarmaStat.Value
local initialBrawls = brawlsStat.Value

--// Update loop
task.spawn(function()
    local lastUpdate = 0
    while task.wait(0.2) do
        local elapsedTime = tick() - startTime
        local days = math.floor(elapsedTime / (24 * 3600))
        local hours = math.floor((elapsedTime % (24 * 3600)) / 3600)
        local minutes = math.floor((elapsedTime % 3600) / 60)
        local seconds = math.floor(elapsedTime % 60)
        stopwatchLabel.Text = string.format("Session Time: %dd %dh %dm %ds", days, hours, minutes, seconds)

        if isCustomRunning then
            customElapsed = tick() - customStart
        end
        if customElapsed > 0 then
            local d = math.floor(customElapsed / (24 * 3600))
            local h = math.floor((customElapsed % (24 * 3600)) / 3600)
            local m = math.floor((customElapsed % 3600) / 60)
            local s = math.floor(customElapsed % 60)
            customTimerLabel.Text = string.format("Custom Timer: %dd %dh %dm %ds", d, h, m, s)
        end

        if resetSession then
            startTime = tick()
            initialStrength = strengthStat.Value
            initialDurability = durabilityStat.Value
            initialRebirths = rebirthsStat.Value
            initialKills = killsStat.Value
            initialAgility = agilityStat.Value
            initialEvilKarma = evilKarmaStat.Value
            initialGoodKarma = goodKarmaStat.Value
            initialBrawls = brawlsStat.Value
            resetSession = false
        end

        local cStr = strengthStat.Value
        local cReb = rebirthsStat.Value
        local cDur = durabilityStat.Value
        local cKills = killsStat.Value
        local cAgi = agilityStat.Value
        local cEvil = evilKarmaStat.Value
        local cGood = goodKarmaStat.Value
        local cBrawl = brawlsStat.Value

        local dStr = cStr - initialStrength
        local dDur = cDur - initialDurability
        local dReb = cReb - initialRebirths
        local dKills = cKills - initialKills
        local dAgi = cAgi - initialAgility
        local dEvil = cEvil - initialEvilKarma
        local dGood = cGood - initialGoodKarma
        local dBrawl = cBrawl - initialBrawls

        strengthLabel.Text = "Strength: " .. AbbrevNumber(cStr) .. " | +" .. AbbrevNumber(dStr)
        rebirthsLabel.Text = "Rebirths: " .. AbbrevNumber(cReb) .. " | +" .. AbbrevNumber(dReb)
        killsLabel.Text = "Kills: " .. AbbrevNumber(cKills) .. " | +" .. AbbrevNumber(dKills)
        brawlsLabel.Text = "Brawls: " .. AbbrevNumber(cBrawl) .. " | +" .. AbbrevNumber(dBrawl)

        goodKarmaLabel.Text = "Good Karma: " .. AbbrevNumber(cGood) .. " | +" .. AbbrevNumber(dGood)
        evilKarmaLabel.Text = "Evil Karma: " .. AbbrevNumber(cEvil) .. " | +" .. AbbrevNumber(dEvil)
        durabilityLabel.Text = "Durability: " .. AbbrevNumber(cDur) .. " | +" .. AbbrevNumber(dDur)
        agilityLabel.Text = "Agility: " .. AbbrevNumber(cAgi) .. " | +" .. AbbrevNumber(dAgi)

        -- projected stats every 6 seconds
        if tick() - lastUpdate >= 6 then
            lastUpdate = tick()
            local sSec = dStr / elapsedTime
            local dSec = dDur / elapsedTime
            local rSec = dReb / elapsedTime

            local h = 3600
            local d = 86400

            projectedStrengthLabel.Text = "Strength Pace: " .. AbbrevNumber(math.floor(sSec * h)) .. "/h | " .. AbbrevNumber(math.floor(sSec * d)) .. "/d"
            projectedDurabilityLabel.Text = "Durability Pace: " .. AbbrevNumber(math.floor(dSec * h)) .. "/h | " .. AbbrevNumber(math.floor(dSec * d)) .. "/d"
            projectedRebirthsLabel.Text = "Rebirth Pace: " .. AbbrevNumber(math.floor(rSec * h)) .. "/h | " .. AbbrevNumber(math.floor(rSec * d)) .. "/d"
        end

        scrollFrame.CanvasSize = UDim2.new(0, 0, 0, uiListLayout.AbsoluteContentSize.Y + 10)
    end
end)

--// Show Stats Toggle
MiscTab:AddToggle("ShowStats", {
    Title = "Show Stats",
    Default = false,
    Callback = function(state)
        screenGui.Enabled = state
    end
})

-- Block Rebirths
MiscTab:AddButton({
    Title = "Block Rebirths",
    Callback = function()
        local old
        old = hookmetamethod(game, "__namecall", function(self, ...)
            local args = { ... }
            if self.Name == "rebirthRemote" and args[1] == "rebirthRequest" then
                return
            end
            return old(self, unpack(args))
        end)
    end
})

-- Block Trades
MiscTab:AddButton({
    Title = "Block Trades",
    Callback = function()
        game:GetService("ReplicatedStorage").rEvents.tradingEvent:FireServer("disableTrading")
    end
})

